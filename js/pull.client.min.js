!function(){if(window.BX){if(window.BX.PullClient)return;if(!window.BX.RestClient)return}else window.BX={};var e=window.BX,t=window.protobuf,n="bx-pull-session",o="webSocket",s="longPolling",i={Online:"online",Offline:"offline",Connecting:"connect"},r=1,c={Server:"server",Client:"client",Online:"online",Status:"status",Revision:"revision"},a={NORMAL_CLOSURE:1e3,SERVER_DIE:1001,CONFIG_REPLACED:3e3,CHANNEL_EXPIRED:3001,SERVER_RESTARTED:3002,CONFIG_EXPIRED:3003,MANUAL:3004},h="CHANNEL_EXPIRE",l="CONFIG_EXPIRE",u="SERVER_RESTART",d="shared",p=(t.roots["push-server"].Response,t.roots["push-server"].ResponseBatch),g=(t.roots["push-server"].Request,t.roots["push-server"].RequestBatch),f=(t.roots["push-server"].IncomingMessagesRequest,t.roots["push-server"].IncomingMessage),m=t.roots["push-server"].Receiver,b=function(t){(t=t||{}).restApplication&&(void 0===t.configGetMethod&&(t.configGetMethod="pull.application.config.get"),void 0===t.skipCheckRevision&&(t.skipCheckRevision=!0),"string"==typeof t.restApplication&&(t.siteId=t.restApplication),t.serverEnabled=!0);var n=this;this.context="master",this.guestMode=t.guestMode?t.guestMode:!(void 0===e.message||!e.message.pull_guest_mode)&&"Y"===e.message.pull_guest_mode,this.guestUserId=t.guestUserId?t.guestUserId:void 0!==e.message&&e.message.pull_guest_user_id?parseInt(e.message.pull_guest_user_id,10):0,this.guestMode&&this.guestUserId?this.userId=this.guestUserId:this.userId=t.userId?t.userId:void 0!==e.message&&e.message.USER_ID?e.message.USER_ID:0,this.siteId=t.siteId?t.siteId:void 0!==e.message&&e.message.SITE_ID?e.message.SITE_ID:"none",this.restClient=void 0!==t.restClient?t.restClient:new e.RestClient(this.getRestClientOptions()),this.enabled=void 0!==t.serverEnabled?"Y"===t.serverEnabled||!0===t.serverEnabled:void 0!==e.message&&"Y"===e.message.pull_server_enabled,this.unloading=!1,this.starting=!1,this.debug=!1,this.connectionAttempt=0,this.connectionType="",this.reconnectTimeout=null,this.restoreWebSocketTimeout=null,this.configGetMethod="string"!=typeof t.configGetMethod?"pull.config.get":t.configGetMethod,this.getPublicListMethod="string"!=typeof t.getPublicListMethod?"pull.channel.public.list":t.getPublicListMethod,this.skipStorageInit=!0===t.skipStorageInit,this.skipCheckRevision=!0===t.skipCheckRevision,this._subscribers={},this.watchTagsQueue={},this.watchUpdateInterval=174e4,this.watchForceUpdateInterval=5e3,void 0!==t.configTimestamp?this.configTimestamp=t.configTimestamp:void 0!==e.message&&e.message.pull_config_timestamp?this.configTimestamp=e.message.pull_config_timestamp:this.configTimestamp=0,this.session={mid:null,tag:null,time:null,history:{},lastMessageIds:[],messageCount:0},this._connectors={webSocket:null,longPolling:null},Object.defineProperty(this,"connector",{get:function(){return n._connectors[n.connectionType]}}),this.isSecure=0===document.location.href.indexOf("https"),this.config=null,this.storage=null,this.userId&&!this.skipStorageInit&&(this.storage=new E({userId:this.userId,siteId:this.siteId})),this.sharedConfig=new y({onWebSocketBlockChanged:this.onWebSocketBlockChanged.bind(this),storage:this.storage}),this.channelManager=new C({restClient:this.restClient,getPublicListMethod:this.getPublicListMethod}),this.notificationPopup=null,this.checkInterval=null,this.offlineTimeout=null,this.isManualDisconnect=!1,this.loggingEnabled=this.sharedConfig.isLoggingEnabled()};b.prototype.subscribe=function(e){return e?w.isPlainObject(e)?((e=e||{}).type=e.type||c.Server,e.command=e.command||null,e.type==c.Server||e.type==c.Client?(void 0===this._subscribers[e.type]&&(this._subscribers[e.type]={}),void 0===this._subscribers[e.type][e.moduleId]&&(this._subscribers[e.type][e.moduleId]={callbacks:[],commands:{}}),e.command?(void 0===this._subscribers[e.type][e.moduleId].commands[e.command]&&(this._subscribers[e.type][e.moduleId].commands[e.command]=[]),this._subscribers[e.type][e.moduleId].commands[e.command].push(e.callback),function(){this._subscribers[e.type][e.moduleId].commands[e.command]=this._subscribers[e.type][e.moduleId].commands[e.command].filter((function(t){return t!==e.callback}))}.bind(this)):(this._subscribers[e.type][e.moduleId].callbacks.push(e.callback),function(){this._subscribers[e.type][e.moduleId].callbacks=this._subscribers[e.type][e.moduleId].callbacks.filter((function(t){return t!==e.callback}))}.bind(this))):(void 0===this._subscribers[e.type]&&(this._subscribers[e.type]=[]),this._subscribers[e.type].push(e.callback),function(){this._subscribers[e.type]=this._subscribers[e.type].filter((function(t){return t!==e.callback}))}.bind(this))):this.attachCommandHandler(e):(console.error(w.getDateForLog()+": Pull.subscribe: params for subscribe function is invalid. "),function(){})},b.prototype.attachCommandHandler=function(e){if("function"!=typeof e.getModuleId||"string"!=typeof e.getModuleId())return console.error(w.getDateForLog()+": Pull.attachCommandHandler: result of handler.getModuleId() is not a string."),function(){};var t=c.Server;return"function"==typeof e.getSubscriptionType&&(t=e.getSubscriptionType()),this.subscribe({type:t,moduleId:e.getModuleId(),callback:function(t){var n=null;if("function"==typeof e.getMap){var o=e.getMap();o&&"object"==typeof o&&("function"==typeof o[t.command]?n=o[t.command].bind(e):"string"==typeof o[t.command]&&"function"==typeof e[o[t.command]]&&(n=e[o[t.command]].bind(e)))}if(!n){var s="handle"+t.command.charAt(0).toUpperCase()+t.command.slice(1);"function"==typeof e[s]&&(n=e[s].bind(e))}n&&(this.debug&&"master"!==this.context&&console.warn(w.getDateForLog()+": Pull.attachCommandHandler: receive command",t),n(t.params,t.extra,t.command))}.bind(this)})},b.prototype.emit=function(e){return(e=e||{}).type==c.Server||e.type==c.Client?(void 0===this._subscribers[e.type]&&(this._subscribers[e.type]={}),void 0===this._subscribers[e.type][e.moduleId]&&(this._subscribers[e.type][e.moduleId]={callbacks:[],commands:{}}),this._subscribers[e.type][e.moduleId].callbacks.length>0&&this._subscribers[e.type][e.moduleId].callbacks.forEach((function(t){t(e.data,{type:e.type,moduleId:e.moduleId})})),this._subscribers[e.type][e.moduleId].commands[e.data.command]&&this._subscribers[e.type][e.moduleId].commands[e.data.command].length>0&&this._subscribers[e.type][e.moduleId].commands[e.data.command].forEach((function(t){t(e.data.params,e.data.extra,e.data.command,{type:e.type,moduleId:e.moduleId})})),!0):(void 0===this._subscribers[e.type]&&(this._subscribers[e.type]=[]),this._subscribers[e.type].length<=0||this._subscribers[e.type].forEach((function(t){t(e.data,{type:e.type})})),!0)},b.prototype.init=function(){this._connectors.webSocket=new S({parent:this,onOpen:this.onWebSocketOpen.bind(this),onMessage:this.parseResponse.bind(this),onDisconnect:this.onWebSocketDisconnect.bind(this),onError:this.onWebSocketError.bind(this)}),this._connectors.longPolling=new I({parent:this,onOpen:this.onLongPollingOpen.bind(this),onMessage:this.parseResponse.bind(this),onDisconnect:this.onLongPollingDisconnect.bind(this),onError:this.onLongPollingError.bind(this)}),this.connectionType=this.isWebSocketAllowed()?o:s,window.addEventListener("beforeunload",this.onBeforeUnload.bind(this)),window.addEventListener("offline",this.onOffline.bind(this)),window.addEventListener("online",this.onOnline.bind(this)),e&&e.addCustomEvent&&e.addCustomEvent("BXLinkOpened",this.connect.bind(this)),e&&e.desktop&&(e.addCustomEvent("onDesktopReload",function(){this.session.mid=null,this.session.tag=null,this.session.time=null}.bind(this)),e.desktop.addCustomEvent("BXLoginSuccess",function(){this.restart(1e3,"Desktop login")}.bind(this)))},b.prototype.start=function(t){var o=!0;if(!this.starting&&!this.isConnected()){!this.userId&&void 0!==e.message&&e.message.USER_ID&&(this.userId=e.message.USER_ID,this.storage||(this.storage=new E({userId:this.userId,siteId:this.siteId}))),"none"===this.siteId&&void 0!==e.message&&e.message.SITE_ID&&(this.siteId=e.message.SITE_ID);var s=new e.Promise,r=!1;if(w.isPlainObject(t)&&(void 0!==t.skipReconnectToLastSession&&(r=!!t.skipReconnectToLastSession,delete t.skipReconnectToLastSession),this.config=t,o=!1),!this.enabled)return s.reject({ex:{error:"PULL_DISABLED",error_description:"Push & Pull server is disabled"}}),s;var c,a=this,h=(new Date).getTime();return!r&&this.storage&&(c=this.storage.get(n)),w.isPlainObject(c)&&c.hasOwnProperty("ttl")&&c.ttl>=h&&(this.session.mid=c.mid),this.starting=!0,this.loadConfig().catch((function(e){a.starting=!1,a.sendPullStatus(i.Offline),a.stopCheckConfig(),console.error(w.getDateForLog()+": Pull: could not read push-server config. ",e),s.reject(e)})).then((function(e){a.setConfig(e,o),a.init(),a.connect(),a.updateWatch(),a.startCheckConfig(),s.resolve(!0)})),s}},b.prototype.getRestClientOptions=function(){var e={};return this.guestMode&&0!==this.guestUserId&&(e.queryParams={pull_guest_id:this.guestUserId}),e},b.prototype.setLastMessageId=function(e){this.session.mid=e},b.prototype.setPublicIds=function(e){return this.channelManager.setPublicIds(e)},b.prototype.sendMessage=function(e,t,n,o,s){return this.sendMessageBatch([{users:e,moduleId:t,command:n,params:o,expiry:s}])},b.prototype.sendMessageToChannels=function(e,t,n,o,s){return this.sendMessageBatch([{publicChannels:e,moduleId:t,command:n,params:o,expiry:s}])},b.prototype.sendMessageBatch=function(e){if(!this.isPublishingEnabled())return console.error("Client publishing is not supported or is disabled"),!1;for(var t={},n=0;n<e.length;n++)if(e[n].users)for(var o=0;o<e[n].users.length;o++)t[e[n].users[o]]=!0;this.channelManager.getPublicIds(Object.keys(t)).then(function(t){return this.connector.send(this.encodeMessageBatch(e,t))}.bind(this))},b.prototype.encodeMessageBatch=function(t,n){var o=[];t.forEach((function(t){var s,i={module_id:t.moduleId,command:t.command,params:t.params};if(s=t.users?this.createMessageReceivers(t.users,n):[],t.publicChannels){if(!e.type.isArray(t.publicChannels))throw new Error("messageFields.publicChannels must be an array");t.publicChannels.forEach(function(e){var t,n;if("string"==typeof e&&e.includes(".")){var o=e.toString().split(".");t=o[0],n=o[1]}else{if("object"!=typeof e||!("publicId"in e)||!("signature"in e))throw new Error("Public channel MUST be either a string, formatted like \"{publicId}.{signature}\" or an object with fields 'publicId' and 'signature'");t=e.publicId,n=e.signature}s.push(m.create({id:this.encodeId(t),signature:this.encodeId(n)}))}.bind(this))}var r=f.create({receivers:s,body:JSON.stringify(i),expiry:t.expiry||0});o.push(r)}),this);var s=g.create({requests:[{incomingMessages:{messages:o}}]});return g.encode(s).finish()},b.prototype.createMessageReceivers=function(e,t){for(var n=[],o=0;o<e.length;o++){var s=e[o];if(!t[s]||!t[s].publicId)throw new Error("Could not determine public id for user "+s);n.push(m.create({id:this.encodeId(t[s].publicId),signature:this.encodeId(t[s].signature)}))}return n},b.prototype.restart=function(t,n){var o=this;this.disconnect(t,n),this.storage&&this.storage.remove("bx-pull-config"),this.config=null,this.loadConfig().catch((function(t){console.error(w.getDateForLog()+": Pull: could not read push-server config",t),o.sendPullStatus(i.Offline),clearTimeout(o.reconnectTimeout),401!=t.status&&403!=t.status||(o.stopCheckConfig(),e&&e.onCustomEvent&&e.onCustomEvent(window,"onPullError",["AUTHORIZE_ERROR"]))})).then((function(e){o.setConfig(e,!0),o.connect(),o.updateWatch(),o.startCheckConfig()}))},b.prototype.loadConfig=function(){var t=new e.Promise;if(this.config){if(this.isConfigActual(this.config)&&this.checkRevision(this.config.api.revision_web))return t.resolve(this.config),t;this.config={api:{},channels:{},publicChannels:{},server:{timeShift:0},clientId:null}}else{var n;if(this.config={api:{},channels:{},publicChannels:{},server:{timeShift:0},clientId:null},this.storage&&(n=this.storage.get("bx-pull-config")),this.isConfigActual(n)&&this.checkRevision(n.api.revision_web))return t.resolve(n),t;this.storage&&this.storage.remove("bx-pull-config")}return this.restClient.callMethod(this.configGetMethod,{CACHE:"N"}).then((function(e){var n,o=e.data();n=Math.floor((w.getTimestamp()-new Date(o.serverTime).getTime())/1e3),delete o.serverTime;var s=Object.assign({},o);s.server.timeShift=n,t.resolve(s)})).catch((function(e){var n=e.error();"AUTHORIZE_ERROR"!=n.getError().error&&"WRONG_AUTH_TYPE"!=n.getError().error||(n.status=403),t.reject(n)})),t},b.prototype.isConfigActual=function(e){if(!w.isPlainObject(e))return!1;if(e.server.config_timestamp<this.configTimestamp)return!1;var t=new Date;if(0===Object.keys(e.channels).length)return!1;for(var n in e.channels)if(e.channels.hasOwnProperty(n)){var o=e.channels[n];if(new Date(o.end)<t)return!1}return!0},b.prototype.startCheckConfig=function(){this.checkInterval&&clearInterval(this.checkInterval),this.checkInterval=setInterval(this.checkConfig.bind(this),6e4)},b.prototype.stopCheckConfig=function(){this.checkInterval&&clearInterval(this.checkInterval),this.checkInterval=null},b.prototype.checkConfig=function(){if(this.isConfigActual(this.config)){if(!this.checkRevision(this.config.api.revision_web))return!1}else this.logToConsole("Stale config detected. Restarting"),this.restart(a.CONFIG_EXPIRED,"Config update required")},b.prototype.setConfig=function(e,t){for(var n in e)e.hasOwnProperty(n)&&this.config.hasOwnProperty(n)&&(this.config[n]=e[n]);if(e.publicChannels&&this.setPublicIds(w.objectValues(e.publicChannels)),this.storage&&t)try{this.storage.set("bx-pull-config",e)}catch(e){localStorage&&localStorage.removeItem&&localStorage.removeItem("history"),console.error(w.getDateForLog()+" Pull: Could not cache config in local storage. Error: ",e)}},b.prototype.isWebSocketSupported=function(){return void 0!==window.WebSocket},b.prototype.isWebSocketAllowed=function(){return!this.sharedConfig.isWebSocketBlocked()&&this.isWebSocketEnabled()},b.prototype.isWebSocketEnabled=function(){return!!this.isWebSocketSupported()&&(this.config&&this.config.server&&!0===this.config.server.websocket_enabled)},b.prototype.isPublishingSupported=function(){return this.getServerVersion()>3},b.prototype.isPublishingEnabled=function(){return!!this.isPublishingSupported()&&(this.config&&this.config.server&&!0===this.config.server.publish_enabled)},b.prototype.isProtobufSupported=function(){return this.getServerVersion()>3&&!w.browser.IsIe()},b.prototype.isSharedMode=function(){return this.getServerMode()==d},b.prototype.disconnect=function(e,t){this.connector&&(this.isManualDisconnect=!0,this.connector.disconnect(e,t))},b.prototype.stop=function(e,t){this.disconnect(e,t),this.stopCheckConfig()},b.prototype.reconnect=function(e,t,n){this.disconnect(e,t),n=n||1,this.scheduleReconnect(n)},b.prototype.restoreWebSocketConnection=function(){if(this.connectionType==o)return!0;this._connectors.webSocket.connect()},b.prototype.scheduleReconnect=function(e){if(!this.enabled)return!1;e||(this.connectionAttempt>3&&this.connectionType===o&&!this.sharedConfig.isLongPollingBlocked()?(this.sharedConfig.setWebSocketBlocked(!0),this.connectionType=s,this.connectionAttempt=1,e=1):e=this.getConnectionAttemptDelay(this.connectionAttempt)),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.logToConsole("Pull: scheduling reconnection in "+e+" seconds; attempt # "+this.connectionAttempt),this.reconnectTimeout=setTimeout(this.connect.bind(this),1e3*e)},b.prototype.scheduleRestoreWebSocketConnection=function(){this.logToConsole("Pull: scheduling restoration of websocket connection in 1800 seconds");var e=this;this.restoreWebSocketTimeout||(this.restoreWebSocketTimeout=setTimeout((function(){e.restoreWebSocketTimeout=0,e.restoreWebSocketConnection()}),18e5))},b.prototype.connect=function(){if(!this.enabled||this.connector.connected)return!1;this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.sendPullStatus(i.Connecting),this.connectionAttempt++,this.connector.connect()},b.prototype.parseResponse=function(e){var t=this.extractMessages(e),n=[];if(0!==t.length){for(var o=0;o<t.length;o++){var s=t[o];s.mid&&this.session.lastMessageIds.includes(s.mid)?console.warn("Duplicate message "+s.mid+" skipped"):(this.session.mid=s.mid||null,this.session.tag=s.tag||null,this.session.time=s.time||null,s.mid&&this.session.lastMessageIds.push(s.mid),n.push(s.text),this.session.history[s.text.module_id]||(this.session.history[s.text.module_id]={}),this.session.history[s.text.module_id][s.text.command]||(this.session.history[s.text.module_id][s.text.command]=0),this.session.history[s.text.module_id][s.text.command]++,this.session.messageCount++)}this.session.lastMessageIds.length>10&&(this.session.lastMessageIds=this.session.lastMessageIds.slice(-10)),this.broadcastMessages(n)}else this.session.mid=null},b.prototype.extractMessages=function(e){return e instanceof ArrayBuffer?this.extractProtobufMessages(e):w.isNotEmptyString(e)?this.extractPlainTextMessages(e):void 0},b.prototype.extractProtobufMessages=function(e){var t=[];try{for(var n=p.decode(new Uint8Array(e)),o=0;o<n.responses.length;o++){if("outgoingMessages"==n.responses[o].command)for(var s=n.responses[o].outgoingMessages.messages,i=0;i<s.length;i++){var r,c=s[i];try{r=JSON.parse(c.body)}catch(e){console.error(w.getDateForLog()+": Pull: Could not parse message body",e);continue}r.extra||(r.extra={}),r.extra.sender={type:c.sender.type},c.sender.id instanceof Uint8Array&&(r.extra.sender.id=this.decodeId(c.sender.id));var a={mid:this.decodeId(c.id),text:r};t.push(a)}}}catch(e){console.error(w.getDateForLog()+": Pull: Could not parse message",e)}return t},b.prototype.extractPlainTextMessages=function(e){var t=[],n=e.match(/#!NGINXNMS!#(.*?)#!NGINXNME!#/gm);if(null===n)return text="\n========= PULL ERROR ===========\nError type: parseResponse error parsing message\n\nData string: "+e+"\n================================\n\n",console.warn(text),t;for(var o=0;o<n.length;o++)if(n[o]=n[o].substring(12,n[o].length-12),!(n[o].length<=0)){try{var s=JSON.parse(n[o])}catch(e){continue}t.push(s)}return t},b.prototype.decodeId=function(e){if(!(e instanceof Uint8Array))throw new Error("encodedId should be an instance of Uint8Array");for(var t="",n=0;n<e.length;n++){var o=e[n].toString(16);1===o.length&&(t+="0"),t+=o}return t},b.prototype.encodeId=function(e){if(!e)return new Uint8Array;for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return new Uint8Array(t)},b.prototype.broadcastMessages=function(t){t.forEach((function(t){var n=t.module_id=t.module_id.toLowerCase(),o=t.command;t.extra||(t.extra={}),t.extra.server_time_unix&&(t.extra.server_time_ago=(w.getTimestamp()-1e3*t.extra.server_time_unix)/1e3-(this.config.server.timeShift?this.config.server.timeShift:0),t.extra.server_time_ago=t.extra.server_time_ago>0?t.extra.server_time_ago:0),this.logMessage(t);try{t.extra.sender&&t.extra.sender.type===r?(void 0!==e.onCustomEvent&&(e.onCustomEvent(window,"onPullClientEvent-"+n,[o,t.params,t.extra],!0),e.onCustomEvent(window,"onPullClientEvent",[n,o,t.params,t.extra],!0)),this.emit({type:c.Client,moduleId:n,data:{command:o,params:w.clone(t.params),extra:w.clone(t.extra)}})):"pull"===n?this.handleInternalPullEvent(o,t):"online"==n?t.extra.server_time_ago<240&&(void 0!==e.onCustomEvent&&e.onCustomEvent(window,"onPullOnlineEvent",[o,t.params,t.extra],!0),this.emit({type:c.Online,data:{command:o,params:w.clone(t.params),extra:w.clone(t.extra)}})):(void 0!==e.onCustomEvent&&(e.onCustomEvent(window,"onPullEvent-"+n,[o,t.params,t.extra],!0),e.onCustomEvent(window,"onPullEvent",[n,o,t.params,t.extra],!0)),this.emit({type:c.Server,moduleId:n,data:{command:o,params:w.clone(t.params),extra:w.clone(t.extra)}}))}catch(n){"object"==typeof console&&(console.warn("\n========= PULL ERROR ===========\nError type: broadcastMessages execute error\nError event: ",n,"\nMessage: ",t,"\n================================\n"),void 0!==e.debug&&e.debug(n))}t.extra&&t.extra.revision_web&&this.checkRevision(t.extra.revision_web)}),this)},b.prototype.logToConsole=function(e){this.loggingEnabled&&console.log(w.getDateForLog()+": "+e)},b.prototype.logMessage=function(e){this.debug&&(e.extra.sender&&e.extra.sender.type===r?console.info("onPullClientEvent-"+e.module_id,e.command,e.params,e.extra):"online"==e.moduleId?console.info("onPullOnlineEvent",e.command,e.params,e.extra):console.info("onPullEvent",e.module_id,e.command,e.params,e.extra))},b.prototype.onLongPollingOpen=function(){this.unloading=!1,this.starting=!1,this.connectionAttempt=0,this.isManualDisconnect=!1,this.sendPullStatus(i.Online),this.offlineTimeout&&(clearTimeout(this.offlineTimeout),this.offlineTimeout=null),this.logToConsole("Pull: Long polling connection with push-server opened"),this.isWebSocketEnabled()&&this.scheduleRestoreWebSocketConnection()},b.prototype.onWebSocketBlockChanged=function(e){var t=e.isWebSocketBlocked;t&&this.connectionType===o&&!this.isConnected()?(clearTimeout(this.reconnectTimeout),this.connectionAttempt=0,this.connectionType=s,this.scheduleReconnect(1)):t||this.connectionType!==s||(clearTimeout(this.reconnectTimeout),clearTimeout(this.restoreWebSocketTimeout),this.connectionAttempt=0,this.connectionType=o,this.scheduleReconnect(1))},b.prototype.onWebSocketOpen=function(){this.unloading=!1,this.starting=!1,this.connectionAttempt=0,this.isManualDisconnect=!1,this.sendPullStatus(i.Online),this.sharedConfig.setWebSocketBlocked(!1),this.sharedConfig.setLongPollingBlocked(!0),this.connectionType==s&&(this.connectionType=o,this._connectors.longPolling.disconnect()),this.offlineTimeout&&(clearTimeout(this.offlineTimeout),this.offlineTimeout=null),this.restoreWebSocketTimeout&&(clearTimeout(this.restoreWebSocketTimeout),this.restoreWebSocketTimeout=null),this.logToConsole("Pull: Websocket connection with push-server opened")},b.prototype.onWebSocketDisconnect=function(e){this.connectionType===o&&(e.code!=a.CONFIG_EXPIRED&&e.code!=a.CHANNEL_EXPIRED&&e.code!=a.CONFIG_REPLACED?this.sendPullStatus(i.Offline):this.offlineTimeout=setTimeout(function(){this.sendPullStatus(i.Offline)}.bind(this),5e3)),e||(e={}),this.logToConsole("Pull: Websocket connection with push-server closed. Code: "+e.code+", reason: "+e.reason),this.isManualDisconnect||this.scheduleReconnect(),this.sharedConfig.setLongPollingBlocked(!0),this.isManualDisconnect=!1},b.prototype.onWebSocketError=function(e){this.starting=!1,this.connectionType===o&&this.sendPullStatus(i.Offline),console.error(w.getDateForLog()+": Pull: WebSocket connection error",e),this.scheduleReconnect()},b.prototype.onLongPollingDisconnect=function(e){this.connectionType===s&&(e.code!=a.CONFIG_EXPIRED&&e.code!=a.CHANNEL_EXPIRED&&e.code!=a.CONFIG_REPLACED?this.sendPullStatus(i.Offline):this.offlineTimeout=setTimeout(function(){this.sendPullStatus(i.Offline)}.bind(this),5500)),e||(e={}),this.logToConsole("Pull: Long polling connection with push-server closed. Code: "+e.code+", reason: "+e.reason),this.isManualDisconnect||this.scheduleReconnect(),this.isManualDisconnect=!1},b.prototype.onLongPollingError=function(e){this.starting=!1,this.connectionType===s&&this.sendPullStatus(i.Offline),console.error(w.getDateForLog()+": Pull: Long polling connection error",e),this.scheduleReconnect()},b.prototype.isConnected=function(){return!!this.connector&&this.connector.connected},b.prototype.onBeforeUnload=function(){this.unloading=!0;var e=w.clone(this.session);if(e.ttl=(new Date).getTime()+2e4,this.storage)try{this.storage.set(n,JSON.stringify(e),20)}catch(e){console.error(w.getDateForLog()+" Pull: Could not save session info in local storage. Error: ",e)}this.scheduleReconnect(15)},b.prototype.onOffline=function(){this.disconnect("1000","offline")},b.prototype.onOnline=function(){this.connect()},b.prototype.handleInternalPullEvent=function(e,t){switch(e.toUpperCase()){case h:"reconnect"==t.params.action?(this.config.channels[t.params.channel.type]=t.params.new_channel,this.logToConsole("Pull: new config for "+t.params.channel.type+" channel set:\n",this.config.channels[t.params.channel.type]),this.reconnect(a.CONFIG_REPLACED,"config was replaced")):this.restart(a.CHANNEL_EXPIRED,"channel expired");break;case l:this.restart(a.CONFIG_EXPIRED,"config expired");break;case u:this.reconnect(a.SERVER_RESTARTED,"server was restarted",15)}},b.prototype.checkRevision=function(t){return!!this.skipCheckRevision||(!((t=parseInt(t))>0&&19!=t)||(this.enabled=!1,void 0!==e.message&&this.showNotification(e.message("PULL_OLD_REVISION")),this.disconnect(a.NORMAL_CLOSURE,"check_revision"),void 0!==e.onCustomEvent&&e.onCustomEvent(window,"onPullRevisionUp",[t,19]),this.emit({type:c.Revision,data:{server:t,client:19}}),this.logToConsole("Pull revision changed from 19 to "+t+". Reload required"),!1))},b.prototype.showNotification=function(t){var n=this;this.notificationPopup||void 0===e.PopupWindow||(this.notificationPopup=new e.PopupWindow("bx-notifier-popup-confirm",null,{zIndex:200,autoHide:!1,closeByEsc:!1,overlay:!0,content:e.create("div",{props:{className:"bx-messenger-confirm"},html:t}),buttons:[new e.PopupWindowButton({text:e.message("JS_CORE_WINDOW_CLOSE"),className:"popup-window-button-decline",events:{click:function(e){n.notificationPopup.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){n.notificationPopup=null}}}),this.notificationPopup.show())},b.prototype.getRevision=function(){return this.config&&this.config.api?this.config.api.revision_web:null},b.prototype.getServerVersion=function(){return this.config&&this.config.server?this.config.server.version:0},b.prototype.getServerMode=function(){return this.config&&this.config.server?this.config.server.mode:null},b.prototype.getConfig=function(){return this.config},b.prototype.getDebugInfo=function(){if(!(console&&console.info&&JSON&&JSON.stringify))return!1;var e;e=this.config&&this.config.channels&&this.config.channels.private?"ChannelID: "+this.config.channels.private.id+"\nChannelDie: "+this.config.channels.private.end+"\n"+("shared"in this.config.channels?"ChannelDieShared: "+this.config.channels.shared.end:""):"Config error: config is not loaded";var t=JSON.stringify(this.watchTagsQueue),n="\n========= PULL DEBUG ===========\nUserId: "+this.userId+" "+(this.userId>0?"":"(guest)")+"\n"+(this.guestMode&&0!==this.guestUserId?"Guest userId: "+this.guestUserId+"\n":"")+"Browser online: "+(navigator.onLine?"Y":"N")+"\nConnect: "+(this.isConnected()?"Y":"N")+"\nServer type: "+(this.isSharedMode()?"cloud":"local")+"\nWebSocket support: "+(this.isWebSocketSupported()?"Y":"N")+"\nWebSocket connect: "+(this._connectors.webSocket&&this._connectors.webSocket.connected?"Y":"N")+"\nWebSocket mode: "+(this._connectors.webSocket&&this._connectors.webSocket.socket?-1!=this._connectors.webSocket.socket.url.search("binaryMode=true")?"protobuf":"text":"-")+"\nTry connect: "+(this.reconnectTimeout?"Y":"N")+"\nTry number: "+this.connectionAttempt+"\n\nPath: "+(this.connector?this.connector.path:"-")+"\n"+e+"\n\nLast message: "+(this.session.mid>0?this.session.mid:"-")+"\nSession history: "+JSON.stringify(this.session.history)+"\nWatch tags: "+("{}"==t?"-":t)+"\n================================\n";return console.info(n)},b.prototype.enableLogging=function(e){void 0===e&&(e=!0),e=!0===e,this.sharedConfig.setLoggingEnabled(e),this.loggingEnabled=e},b.prototype.capturePullEvent=function(e){void 0===e&&(e=!0),this.debug=e},b.prototype.getConnectionPath=function(e){var t;switch(e){case o:t=this.isSecure?this.config.server.websocket_secure:this.config.server.websocket;break;case s:t=this.isSecure?this.config.server.long_pooling_secure:this.config.server.long_polling;break;default:throw new Error("Unknown connection type "+e)}if(!w.isNotEmptyString(t))return!1;var n=[];if(["private","shared"].forEach((function(e){void 0!==this.config.channels[e]&&n.push(this.config.channels[e].id)}),this),0===n.length)return!1;var i={CHANNEL_ID:n.join("/")};if(this.isProtobufSupported()&&(i.binaryMode="true"),this.isSharedMode()){if(!this.config.clientId)throw new Error("Push-server is in shared mode, but clientId is not set");i.clientId=this.config.clientId}return this.session.mid&&(i.mid=this.session.mid),this.session.tag&&(i.tag=this.session.tag),this.session.time&&(i.time=this.session.time),i.revision=19,t+"?"+w.buildQueryString(i)},b.prototype.getPublicationPath=function(){var e=this.isSecure?this.config.server.publish_secure:this.config.server.publish;if(!e)return"";var t=[];for(var n in this.config.channels)this.config.channels.hasOwnProperty(n)&&t.push(this.config.channels[n].id);var o={CHANNEL_ID:t.join("/")};return e+"?"+w.buildQueryString(o)},b.prototype.getConnectionAttemptDelay=function(e){var t;return(t=e<1?.5:e<3?15:e<5?45:e<10?600:3600)+t*Math.random()*.2},b.prototype.sendPullStatus=function(t){this.unloading||(void 0!==e.onCustomEvent&&e.onCustomEvent(window,"onPullStatus",[t]),this.emit({type:c.Status,data:{status:t}}))},b.prototype.extendWatch=function(e,t){if(!e||this.watchTagsQueue[e])return!1;this.watchTagsQueue[e]=!0,t&&this.updateWatch(t)},b.prototype.updateWatch=function(e){clearTimeout(this.watchUpdateTimeout),this.watchUpdateTimeout=setTimeout(function(){var e=Object.keys(this.watchTagsQueue);e.length>0?this.restClient.callMethod("pull.watch.extend",{tags:e},function(e){if(e.error())return this.updateWatch(),!1;var t=e.data();for(var n in t)t.hasOwnProperty(n)&&!t[n]&&this.clearWatch(n);this.updateWatch()}.bind(this)):this.updateWatch()}.bind(this),e?this.watchForceUpdateInterval:this.watchUpdateInterval)},b.prototype.clearWatch=function(e){delete this.watchTagsQueue[e]},b.prototype.setPrivateVar=function(){},b.prototype.returnPrivateVar=function(){},b.prototype.expireConfig=function(){},b.prototype.updateChannelID=function(){},b.prototype.tryConnect=function(){},b.prototype.tryConnectDelay=function(){},b.prototype.tryConnectSet=function(){},b.prototype.updateState=function(){},b.prototype.setUpdateStateStepCount=function(){},b.prototype.supportWebSocket=function(){return this.isWebSocketSupported()},b.prototype.isWebSoketConnected=function(){return this.isConnected()&&this.connectionType==o},b.prototype.getPullServerStatus=function(){return this.isConnected()},b.prototype.closeConfirm=function(){this.notificationPopup&&this.notificationPopup.destroy()};var y=function(e){e=e||{},this.storage=e.storage||new E,this.ttl=86400,this.lsKeys={websocketBlocked:"bx-pull-websocket-blocked",longPollingBlocked:"bx-pull-longpolling-blocked",loggingEnabled:"bx-pull-logging-enabled"},this.callbacks={onWebSocketBlockChanged:w.isFunction(e.onWebSocketBlockChanged)?e.onWebSocketBlockChanged:function(){}},this.storage&&window.addEventListener("storage",this.onLocalStorageSet.bind(this))};y.prototype.onLocalStorageSet=function(e){this.storage.compareKey(e.key,this.lsKeys.websocketBlocked)&&e.newValue!=e.oldValue&&this.callbacks.onWebSocketBlockChanged({isWebSocketBlocked:this.isWebSocketBlocked()})},y.prototype.isWebSocketBlocked=function(){return!!this.storage&&this.storage.get(this.lsKeys.websocketBlocked,0)>w.getTimestamp()},y.prototype.setWebSocketBlocked=function(e){if(!this.storage)return!1;try{this.storage.set(this.lsKeys.websocketBlocked,e?w.getTimestamp()+this.ttl:0)}catch(e){console.error(w.getDateForLog()+" Pull: Could not save WS_blocked flag in local storage. Error: ",e)}},y.prototype.isLongPollingBlocked=function(){return!!this.storage&&this.storage.get(this.lsKeys.longPollingBlocked,0)>w.getTimestamp()},y.prototype.setLongPollingBlocked=function(e){if(!this.storage)return!1;try{this.storage.set(this.lsKeys.longPollingBlocked,e?w.getTimestamp()+this.ttl:0)}catch(e){console.error(w.getDateForLog()+" Pull: Could not save LP_blocked flag in local storage. Error: ",e)}},y.prototype.isLoggingEnabled=function(){return!!this.storage&&this.storage.get(this.lsKeys.loggingEnabled,0)>w.getTimestamp()},y.prototype.setLoggingEnabled=function(e){if(!this.storage)return!1;try{this.storage.set(this.lsKeys.loggingEnabled,e?w.getTimestamp()+this.ttl:0)}catch(e){return console.error("LocalStorage error: ",e),!1}};var v=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)},k=function(e){this.parent=e.parent,this.callbacks={onOpen:w.isFunction(e.onOpen)?e.onOpen:function(){},onDisconnect:w.isFunction(e.onDisconnect)?e.onDisconnect:function(){},onError:w.isFunction(e.onError)?e.onError:function(){},onMessage:w.isFunction(e.onMessage)?e.onMessage:function(){}},this._connected=!1,this.connectionType="",this.disconnectCode="",this.disconnectReason="",Object.defineProperty(this,"connected",{get:function(){return this._connected},set:function(e){e!=this._connected&&(this._connected=e,this._connected?this.callbacks.onOpen():this.callbacks.onDisconnect({code:this.disconnectCode,reason:this.disconnectReason}))}}),Object.defineProperty(this,"path",{get:function(){return this.parent.getConnectionPath(this.connectionType)}})},S=function(e){S.superclass.constructor.apply(this,arguments),this.connectionType=o,this.socket=null,this.onSocketOpenHandler=this.onSocketOpen.bind(this),this.onSocketCloseHandler=this.onSocketClose.bind(this),this.onSocketErrorHandler=this.onSocketError.bind(this),this.onSocketMessageHandler=this.onSocketMessage.bind(this)};v(S,k),S.prototype.connect=function(){if(this.socket){if(1===this.socket.readyState)return!0;this.socket.removeEventListener("open",this.onSocketOpenHandler),this.socket.removeEventListener("close",this.onSocketCloseHandler),this.socket.removeEventListener("error",this.onSocketErrorHandler),this.socket.removeEventListener("message",this.onSocketMessageHandler),this.socket.close(),this.socket=null}this.createSocket()},S.prototype.disconnect=function(e,t){null!==this.socket&&(this.socket.removeEventListener("open",this.onSocketOpenHandler),this.socket.removeEventListener("close",this.onSocketCloseHandler),this.socket.removeEventListener("error",this.onSocketErrorHandler),this.socket.removeEventListener("message",this.onSocketMessageHandler),this.socket.close(e,t)),this.socket=null,this.disconnectCode=e,this.disconnectReason=t,this.connected=!1},S.prototype.createSocket=function(){if(this.socket)throw new Error("Socket already exists");if(!this.path)throw new Error("Websocket connection path is not defined");this.socket=new WebSocket(this.path),this.socket.binaryType="arraybuffer",this.socket.addEventListener("open",this.onSocketOpenHandler),this.socket.addEventListener("close",this.onSocketCloseHandler),this.socket.addEventListener("error",this.onSocketErrorHandler),this.socket.addEventListener("message",this.onSocketMessageHandler)},S.prototype.send=function(e){if(!this.socket||1!==this.socket.readyState)return console.error(w.getDateForLog()+": Pull: WebSocket is not connected"),!1;this.socket.send(e)},S.prototype.onSocketOpen=function(){this.connected=!0},S.prototype.onSocketClose=function(e){this.socket=null,this.disconnectCode=e.code,this.disconnectReason=e.reason,this.connected=!1},S.prototype.onSocketError=function(e){this.callbacks.onError(e)},S.prototype.onSocketMessage=function(e){this.callbacks.onMessage(e.data)},S.prototype.destroy=function(){this.socket&&(this.socket.close(),this.socket=null)};var I=function(e){I.superclass.constructor.apply(this,arguments),this.active=!1,this.connectionType=s,this.requestTimeout=null,this.failureTimeout=null,this.xhr=this.createXhr(),this.requestAborted=!1};v(I,k),I.prototype.createXhr=function(){var e=new XMLHttpRequest;return this.parent.isProtobufSupported()&&(e.responseType="arraybuffer"),e.addEventListener("readystatechange",this.onXhrReadyStateChange.bind(this)),e},I.prototype.connect=function(){this.active=!0,this.performRequest()},I.prototype.disconnect=function(e,t){this.active=!1,this.failureTimeout&&(clearTimeout(this.failureTimeout),this.failureTimeout=null),this.requestTimeout&&(clearTimeout(this.requestTimeout),this.requestTimeout=null),this.xhr&&(this.requestAborted=!0,this.xhr.abort()),this.disconnectCode=e,this.disconnectReason=t,this.connected=!1},I.prototype.performRequest=function(){var e=this;if(this.active){if(!this.path)throw new Error("Long polling connection path is not defined");0!==this.xhr.readyState&&4!==this.xhr.readyState||(clearTimeout(this.failureTimeout),clearTimeout(this.requestTimeout),this.failureTimeout=setTimeout((function(){e.connected=!0}),5e3),this.requestTimeout=setTimeout(this.onRequestTimeout.bind(this),6e4),this.xhr.open("GET",this.path),this.xhr.send())}},I.prototype.onRequestTimeout=function(){this.requestAborted=!0,this.xhr.abort(),this.performRequest()},I.prototype.onXhrReadyStateChange=function(e){4===this.xhr.readyState&&(this.requestAborted&&200!=this.xhr.status||this.onResponse(this.xhr.response),this.requestAborted=!1)},I.prototype.send=function(e){var t=this.parent.getPublicationPath();if(!t)return console.error(w.getDateForLog()+": Pull: publication path is empty"),!1;var n=new XMLHttpRequest;n.open("POST",t),n.send(e)},I.prototype.onResponse=function(e){if(this.failureTimeout&&(clearTimeout(this.failureTimeout),this.failureTimeout=0),this.requestTimeout&&(clearTimeout(this.requestTimeout),this.requestTimeout=0),200==this.xhr.status)this.connected=!0,w.isNotEmptyString(e)||e instanceof ArrayBuffer?this.callbacks.onMessage(e):this.parent.session.mid=null,this.performRequest();else if(304==this.xhr.status){if(this.connected=!0,"Thu, 01 Jan 1973 11:11:01 GMT"===this.xhr.getResponseHeader("Expires")){var t=this.xhr.getResponseHeader("Last-Message-Id");w.isNotEmptyString(t)&&this.parent.setLastMessageId(t)}this.performRequest()}else this.callbacks.onError("Could not connect to the server"),this.connected=!1};var C=function(t){this.publicIds={},this.restClient=void 0!==t.restClient?t.restClient:e.rest,this.getPublicListMethod=t.getPublicListMethod};C.prototype.getPublicIds=function(t){for(var n=new e.Promise,o={},s=new Date,i=[],r=0;r<t.length;r++){var c=t[r];this.publicIds[c]&&this.publicIds[c].end>s?o[c]=this.publicIds[c]:i.push(c)}return 0===i.length?(n.resolve(o),n):(this.restClient.callMethod(this.getPublicListMethod,{users:i}).then(function(e){if(e.error())return n.resolve({}),n;var t=e.data();this.setPublicIds(w.objectValues(t)),i.forEach((function(e){o[e]=this.publicIds[e]}),this),n.resolve(o)}.bind(this)),n)},C.prototype.setPublicIds=function(e){for(var t=0;t<e.length;t++){var n=e[t],o=n.user_id;this.publicIds[o]={userId:o,publicId:n.public_id,signature:n.signature,start:new Date(n.start),end:new Date(n.end)}}};var E=function(t){t=t||{},this.userId=t.userId?t.userId:void 0!==e.message&&e.message.USER_ID?e.message.USER_ID:0,this.siteId=t.siteId?t.siteId:void 0!==e.message&&e.message.SITE_ID?e.message.SITE_ID:"none"};E.prototype.set=function(e,t){return void 0!==window.localStorage&&("string"!=typeof t&&t&&(t=JSON.stringify(t)),window.localStorage.setItem(this.getKey(e),t))},E.prototype.get=function(e,t){if(void 0===window.localStorage)return t||null;var n=window.localStorage.getItem(this.getKey(e));return null===n?t||null:JSON.parse(n)},E.prototype.remove=function(e){return void 0!==window.localStorage&&window.localStorage.removeItem(this.getKey(e))},E.prototype.getKey=function(e){return"bx-pull-"+this.userId+"-"+this.siteId+"-"+e},E.prototype.compareKey=function(e,t){return e===this.getKey(t)};var w={browser:{IsChrome:function(){return-1!=navigator.userAgent.toLowerCase().indexOf("chrome")},IsFirefox:function(){return-1!=navigator.userAgent.toLowerCase().indexOf("firefox")},IsIe:function(){return null!==navigator.userAgent.match(/(Trident\/|MSIE\/)/)}},getTimestamp:function(){return(new Date).getTime()},errorsToString:function(e){return this.isArray(e)?e.reduce((function(e,t){return""!=e&&(e+="; "),e+t.code+": "+t.message}),""):""},isString:function(e){return""===e||!!e&&("string"==typeof e||e instanceof String)},isArray:function(e){return e&&"[object Array]"==Object.prototype.toString.call(e)},isFunction:function(e){return null!==e&&("function"==typeof e||e instanceof Function)},isDomNode:function(e){return e&&"object"==typeof e&&"nodeType"in e},isDate:function(e){return e&&"[object Date]"==Object.prototype.toString.call(e)},isPlainObject:function(e){if(!e||"object"!=typeof e||e.nodeType)return!1;var t,n=Object.prototype.hasOwnProperty;try{if(e.constructor&&!n.call(e,"constructor")&&!n.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}for(t in e);return void 0===t||n.call(e,t)},isNotEmptyString:function(e){return!!this.isString(e)&&e.length>0},buildQueryString:function(e){var t="";for(var n in e)if(e.hasOwnProperty(n)){var o=e[n];w.isArray(o)?o.forEach((function(e,o){t+=encodeURIComponent(n+"["+o+"]")+"="+encodeURIComponent(e)+"&"})):t+=encodeURIComponent(n)+"="+encodeURIComponent(o)+"&"}return t.length>0&&(t=t.substr(0,t.length-1)),t},objectValues:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&e.propertyIsEnumerable(n)&&t.push(e[n]);return t},clone:function(e,t){var n,o,s;if(!1!==t&&(t=!0),null===e)return null;if(this.isDomNode(e))n=e.cloneNode(t);else if("object"==typeof e)if(this.isArray(e))for(n=[],o=0,s=e.length;o<s;o++)"object"==typeof e[o]&&t?n[o]=this.clone(e[o],t):n[o]=e[o];else for(o in n={},e.constructor&&(n=this.isDate(e)?new Date(e):new e.constructor),e)e.hasOwnProperty(o)&&("object"==typeof e[o]&&t?n[o]=this.clone(e[o],t):n[o]=e[o]);else n=e;return n},getDateForLog:function(){var e=new Date;return e.getFullYear()+"-"+w.lpad(e.getMonth(),2,"0")+"-"+w.lpad(e.getDate(),2,"0")+" "+w.lpad(e.getHours(),2,"0")+":"+w.lpad(e.getMinutes(),2,"0")},lpad:function(e,t,n){if(n=n||" ",(e=e.toString()).length>t)return e;for(var o="",s=0;s<t-e.length;s++)o+=n;return o+e}};void 0!==e.namespace&&void 0===e.PULL&&(e.PULL=new b),e.PullClient=b,e.PullClient.PullStatus=i,e.PullClient.SubscriptionType=c,e.PullClient.CloseReasons=a,e.PullClient.StorageManager=E}();