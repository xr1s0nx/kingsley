"use strict";!function(){if(window.BX){if(window.BX.RestClient)return}else window.BX={};var e=window.BX;if(e.RestClient=function(e){e=e||{},this.endpoint=e.endpoint||"/rest",this.queryParams=e.queryParams||"",this.cors=!0===e.cors},e.RestClient.prototype.callMethod=function(e,t,r,o,s){return n({method:e,data:t,callback:r,sendCallback:o,logTag:s,endpoint:this.endpoint,queryParams:this.queryParams,cors:this.cors})},e.RestClient.prototype.callBatch=function(e,t,o,s,i){var a=r.isArray(e)?[]:{},c=0,u=function(e){n.batch(e,t,o,s,this.endpoint,this.queryParams,this.cors,i)}.bind(this);for(var l in e){var p=null,f=null;e[l]&&e.hasOwnProperty(l)&&(r.isArray(e[l])?(p=e[l][0],f=e[l][1]):e[l].method&&(p=e[l].method,f=e[l].params),p&&(c++,a[l]=[p,f]))}if(c>0){var d=function(e){return function(t){a[e]=a[e][0]+"?"+t,--c<=0&&u(a)}};for(var h in a)a.hasOwnProperty(h)&&n.prepareData(a[h][1],"",d(h))}},e.RestClient.prototype.setEndpoint=function(e){this.endpoint=e},e.RestClient.prototype.enableCorsRequest=function(e){this.cors=!0===e},e.RestClient.prototype.setQueryParams=function(e){this.queryParams=e},void 0!==e.namespace){var t=new e.RestClient;void 0===e.rest&&(e.rest={}),e.rest.callMethod=function(e,r,n,o,s){return t.callMethod(e,r,n,o,s)},e.rest.callBatch=function(e,r,n,o,s){return t.callBatch(e,r,n,o,s)}}var r={isArray:function(e){return e&&"[object Array]"==Object.prototype.toString.call(e)},isFunction:function(e){return null!==e&&("function"==typeof e||e instanceof Function)},isString:function(e){return""===e||!!e&&("string"==typeof e||e instanceof String)},isDomNode:function(e){return e&&"object"==typeof e&&"nodeType"in e},isDate:function(e){return e&&"[object Date]"==Object.prototype.toString.call(e)},buildQueryString:function(e){var t="";for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];this.isArray(n)?n.forEach((function(e,n){t+=encodeURIComponent(r+"["+n+"]")+"="+encodeURIComponent(e)+"&"})):t+=encodeURIComponent(r)+"="+encodeURIComponent(n)+"&"}return t.length>0&&(t=t.substr(0,t.length-1)),t},clone:function(e,t){var r,n,o;if(!1!==t&&(t=!0),null===e)return null;if(this.isDomNode(e))r=e.cloneNode(t);else if("object"==typeof e)if(this.isArray(e))for(r=[],n=0,o=e.length;n<o;n++)"object"==typeof e[n]&&t?r[n]=this.clone(e[n],t):r[n]=e[n];else for(n in r={},e.constructor&&(r=this.isDate(e)?new Date(e):new e.constructor),e)"object"==typeof e[n]&&t?r[n]=this.clone(e[n],t):r[n]=e[n];else r=e;return r}},n=function(t){var s=!!t.callback&&r.isFunction(t.callback),i=void 0===e.Promise||s?null:new e.Promise,a=t.sendCallback||function(){},c=t.withoutRestoringCsrf||!1,u=t.loginAttempt||0,l=n.xhr(),p=t.endpoint+"/"+n.escape(t.method)+".json"+(t.logTag?"?logTag="+t.logTag:"");l.open("POST",p),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.cors&&(l.withCredentials=!0);l.onprogress=function(){},l.ontimeout=function(){},l.timeout=0,l.onload=function(){l.onload=function(){};var r=n.isSuccess(l),a=l.status;if(r){var p=l.responseText;if(p.length>0)try{p=JSON.parse(p)}catch(e){r=!1}if(401==a){if("user_not_authorized"===p.extended_error&&0===u){if(p.sessid&&(console.warn("BX.rest: csrf-token has expired, replace to a new token"),e.message({bitrix_sessid:p.sessid})),"BXDesktopSystem"in window)return console.warn("BX.rest: you are not authorized, trying to log in"),t.loginAttempt=1,BXDesktopSystem.Login({success:function(){console.warn("BX.rest: successfully logged in, repeating request"),s||(t.callback=function(e){e.error()?i.reject(e):i.fulfill(e)}),n(t)}}),!0}else if(p.sessid&&!c)return e.message({bitrix_sessid:p.sessid}),console.warn("BX.rest: your csrf-token has expired, send query with a new token"),t.withoutRestoringCsrf=!0,s||(t.callback=function(e){e.error()?i.reject(e):i.fulfill(e)}),n(t),!0}else 0==a?p={result:{},error:"ERROR_NETWORK",error_description:"A network error occurred while the request was being executed."}:200==a?p.length<=0&&(p={result:{},error:"BLANK_ANSWER",error_description:"Empty answer with correct http code, network error possible."}):p.length<=0&&(p={result:{},error:"BLANK_ANSWER_WITH_ERROR_CODE",error_description:"Empty answer with error http code: "+a})}if(l=null,r){var f=new o(p,t,a);s?t.callback.apply(window,[f]):f.error()?i.reject(f):i.fulfill(f)}else{f=new o({error:"ERROR_UNEXPECTED_ANSWER",error_description:"Server returned an unexpected response.",ex:{}},t,0);s?t.callback.apply(window,[f]):i.reject(f)}},l.onerror=function(e){var r=new o({error:"ERROR_NETWORK",error_description:"A network error occurred while the request was being executed.",ex:e},t,0);s?t.callback.apply(window,[r]):i.reject(r)};var f="";return t.queryParams?f=r.buildQueryString(t.queryParams):void 0!==e.bitrix_sessid&&(f="sessid="+e.bitrix_sessid()),void 0!==t.start&&(f+="&start="+parseInt(t.start)),t.data?n.prepareData(t.data,"",(function(e){f+="&"+e,l.send(f),a(l)})):(l.send(f),a(l)),s||!i?l:i};n.batch=function(e,t,s,i,a,c,u,l){return n({method:"batch",data:{halt:s?1:0,cmd:e},callback:function(n,s,i){if(!t)return!1;var l=n.error(),p=n.data(),f=r.isArray(e)?[]:{};for(var d in e)if(e[d]&&e.hasOwnProperty(d)){if(r.isString(e[d]))var h=e[d].split("?");else h=[r.isArray(e[d])?e[d][0]:e[d].method,r.isArray(e[d])?e[d][1]:e[d].data];!p||void 0===p.result||void 0===p.result[d]&&void 0===p.result_error[d]?l&&(f[d]=new o({result:{},error:l.ex,total:0},{method:h[0],data:h[1],callback:t,endpoint:a,queryParams:c,cors:u},n.status)):f[d]=new o({result:void 0!==p.result[d]?p.result[d]:{},error:p.result_error[d]||void 0,total:p.result_total[d],time:p.result_time[d],next:p.result_next[d]},{method:h[0],data:h[1],callback:t,endpoint:a,queryParams:c,cors:u},n.status)}t.apply(window,[f])},sendCallback:i,endpoint:a,queryParams:c,cors:u,logTag:l})},n.xhr=function(){return new XMLHttpRequest},n.escape=function(e){return encodeURIComponent(e)},n.prepareData=function(e,t,o){var s="",i=[];if(r.isString(e)||null===e)o.call(document,e||"");else{for(var c in e)if(e.hasOwnProperty(c)){var u=n.escape(c);if(t&&(u=t+"["+u+"]"),"object"==typeof e[c]){if(r.isArray(e[c])&&e[c].length<=0)continue;i.push([u,e[c]])}else s.length>0&&(s+="&"),"boolean"==typeof e[c]?s+=u+"="+(e[c]?1:0):s+=u+"="+n.escape(e[c])}var l=i.length;if(l>0){var p=function(e){s+=(e?"&":"")+e,--l<=0&&o.call(document,s)},f=l;for(c=0;c<f;c++)r.isDomNode(i[c][1])?"INPUT"===i[c][1].tagName.toUpperCase()&&"file"===i[c][1].type?a.canUse()&&a(i[c][1],function(e){return function(t){r.isArray(t)&&t.length>0?p(e+"[0]="+n.escape(t[0])+"&"+e+"[1]="+n.escape(t[1])):p(e+"=")}}(i[c][0])):void 0!==i[c][1].value?p(i[c][0]+"="+n.escape(i[c][1].value)):p(""):r.isDate(i[c][1])?p(i[c][0]+"="+n.escape(i[c][1].toJSON())):r.isArray(i[c][1])&&i[c][1].length<=0?p(i[c][0]+"="):n.prepareData(i[c][1],i[c][0],p)}else o.call(document,s)}},n.isSuccess=function(e){return void 0===e.status||e.status>=200&&e.status<300||304===e.status||e.status>=400&&e.status<500||1223===e.status||0===e.status};var o=function(e,t,n){this.answer=e,this.query=r.clone(t),this.status=n,void 0!==this.answer.next&&(this.answer.next=parseInt(this.answer.next)),void 0!==this.answer.error&&(this.answer.ex=new s(this.status,"string"==typeof this.answer.error?this.answer:this.answer.error))};o.prototype.data=function(){return this.answer.result},o.prototype.time=function(){return this.answer.time},o.prototype.error=function(){return this.answer.ex},o.prototype.error_description=function(){return this.answer.error_description},o.prototype.more=function(){return!isNaN(this.answer.next)},o.prototype.total=function(){return parseInt(this.answer.total)},o.prototype.next=function(e){return!!this.more()&&(this.query.start=this.answer.next,e&&r.isFunction(e)&&(this.query.callback=e),n(this.query))};var s=function(e,t){this.status=e,this.ex=t};s.prototype.getError=function(){return this.ex},s.prototype.getStatus=function(){return this.status},s.prototype.toString=function(){return this.ex.error+(this.ex.error_description?": "+this.ex.error_description:"")+" ("+this.status+")"};var i=function(e){var t=new Uint8Array(e),r="";if("function"==typeof t.forEach)t.forEach((function(e){r+=String.fromCharCode(e)}));else for(var n=t.length,o=0;o<n;o+=1)r+=String.fromCharCode(t[o]);return btoa(r)},a=function(e,t){if(a.canUse()){for(var r,n=e.files,o=0,s=e.multiple?[]:null,c=0;r=n[c];c++){var u=new window.FileReader;u.BXFILENAME=n[c].name,u.onload=function(e){e=e||window.event;var r=[this.BXFILENAME,i(e.target.result)];null===s?s=r:s.push(r),--o<=0&&t(s)},u.readAsArrayBuffer(r)}(o=c)<=0&&t(s)}};a.canUse=function(){return!!window.FileReader}}();